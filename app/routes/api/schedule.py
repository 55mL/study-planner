from flask import Blueprint, jsonify, session
from app.models import User, DailyAllocations, ReadingPlans
from app.utils.utils import get_today
import datetime

schedule_api = Blueprint('schedule_api', __name__, url_prefix='/api')

def get_current_user():
    user_id = session.get('_user_id')
    if not user_id:
        return None
    return User.query.get(int(user_id))

@schedule_api.route('/schedule', methods=['GET'])
def get_schedule():
    """‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"""
    user = get_current_user()
    if not user:
        return jsonify({'error': 'Unauthorized'}), 401

    simulated_today = get_today()

    # ‡∏î‡∏∂‡∏á allocations ‡πÅ‡∏•‡∏∞ plans
    allocations = (DailyAllocations.query
                   .filter_by(user_id=user.id)
                   .order_by(DailyAllocations.date.asc())
                   .all())
    plans = ReadingPlans.query.filter_by(user_id=user.id).all()

    # ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö (exam_name -> exam_date) ‡πÅ‡∏•‡∏∞ map ‡∏Ç‡∏≠‡∏á plan ‡πÇ‡∏î‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á level
    exam_dates_map = {plan.exam_name: plan.exam_date for plan in plans}
    plan_by_name = {plan.exam_name: plan for plan in plans}

    events = []
    # ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å set ‡πÄ‡∏õ‡πá‡∏ô dict ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    exam_dates_added = {}  # {date: [exam_name1, exam_name2, ...]}

    print(f"\n{'='*60}")
    print(f"üìä Processing allocations...")

    # 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° allocations (‡∏ß‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô)
    for alloc in allocations:
        date_str = alloc.date.strftime('%Y-%m-%d')
        exam_date = exam_dates_map.get(alloc.exam_name_snapshot)

        if exam_date:
            # ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ >= ‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤)
            if alloc.date >= exam_date:
                print(f"‚ö†Ô∏è SKIP: {date_str} >= exam date {exam_date.strftime('%Y-%m-%d')}")
                continue

            # ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ level ‡∏à‡∏≤‡∏Å plan (ReadingPlans.level)
            plan = plan_by_name.get(alloc.exam_name_snapshot)
            level_value = plan.level if plan else None

            print(f"‚úÖ ADD study day: {date_str} ({alloc.exam_name_snapshot}, {alloc.slots} ‡∏ä‡∏°., level={level_value})")

            events.append({
                'day': date_str,
                'exam': alloc.exam_name_snapshot,
                'slots': alloc.slots,
                'is_exam_day': False,
                'feedback_done': alloc.feedback_done,
                'event_type': 'study',
                'level': level_value
            })

    # 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö (‡∏à‡∏≤‡∏Å plans) - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    for plan in plans:
        if plan.exam_date:
            exam_date_str = plan.exam_date.strftime('%Y-%m-%d')

            # ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ exam_name ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            if exam_date_str not in exam_dates_added:
                exam_dates_added[exam_date_str] = []

            # ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°
            if plan.exam_name not in exam_dates_added[exam_date_str]:
                exam_dates_added[exam_date_str].append(plan.exam_name)

                print(f"‚úÖ ADD exam day: {exam_date_str} ({plan.exam_name}, level={plan.level})")

                events.append({
                    'day': exam_date_str,
                    'exam': plan.exam_name,
                    'slots': 0,
                    'is_exam_day': True,
                    'feedback_done': False,
                    'event_type': 'exam',
                    'level': plan.level
                })

    print(f"{'='*60}\n")

    return jsonify({
        'simulated_today': simulated_today.strftime('%Y-%m-%d'),
        'events': events
    })