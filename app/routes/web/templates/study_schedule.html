{% extends "base.html" %}

{% block title %}Study Schedule{% endblock %}

{% block content %}
<h2>üìÖ Study Schedule (Calendar View)</h2>

<!-- Legend -->
<div style="margin-bottom:10px;">
  <span style="background:#ff4d4d;color:white;padding:2px 6px;border-radius:4px;">‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö</span>
  <span style="background:#d3d3d3;padding:2px 6px;border-radius:4px;">‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
  <span style="background:#add8e6;padding:2px 6px;border-radius:4px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô</span>
  <span style="background:#ccc;padding:2px 6px;border-radius:4px;">‡∏™‡∏µ‡∏™‡∏∏‡πà‡∏° pastel = ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</span>
  <span style="background:#fff3cd;padding:2px 6px;border-radius:4px;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</span>
</div>

<div id="calendar"></div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var simulatedToday = "{{ simulated_today.isoformat() }}";

    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    var examDays = [
      {% for e in events if e.is_exam_day %}
        "{{ e.day.isoformat() }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á Date ‚Üí YYYY-MM-DD (local)
    function formatDateLocal(dateObj) {
      let y = dateObj.getFullYear();
      let m = String(dateObj.getMonth() + 1).padStart(2, '0');
      let d = String(dateObj.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    var subjectColors = {};
    function getRandomPastelColor() {
      var hue = Math.floor(Math.random() * 360);
      return "hsl(" + hue + ", 70%, 80%)";
    }
    function getColorForSubject(subject) {
      if (!subjectColors[subject]) {
        subjectColors[subject] = getRandomPastelColor();
      }
      return subjectColors[subject];
    }

    var events = [
      {% for e in events %}
        {% if e.is_exam_day %}
          {
            title: "{{ e.exam }}",   // ‚úÖ ‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤
            start: "{{ e.day.isoformat() }}",
            allDay: true,
            color: "#ff4d4d",        // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏î‡∏á
            textColor: "black"       // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏µ‡∏î‡∏≥
          }
        {% elif e.feedback_done %}
          {
            title: "{{ e.exam }} (‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß)",
            start: "{{ e.day.isoformat() }}",
            allDay: true,
            color: "#d3d3d3",
            textColor: "black"
          }
        {% elif e.day <= simulated_today %}
          {
            title: "{{ e.exam }} (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô)",
            start: "{{ e.day.isoformat() }}",
            allDay: true,
            color: "#add8e6",
            textColor: "black"
          }
        {% else %}
          {
            title: "{{ e.exam }} ({{ e.slots }} slots)",
            start: "{{ e.day.isoformat() }}",
            allDay: true,
            color: getColorForSubject("{{ e.exam }}"),
            textColor: "black"
          }
        {% endif %}
        {% if not loop.last %},{% endif %}
      {% endfor %}
    ];


    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 'auto',
      events: events,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,listWeek'
      },
      initialDate: simulatedToday,
      nowIndicator: true,

      // ‚úÖ Highlight ‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö + ‡∏ß‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á
      dayCellDidMount: function(info) {
        let cellDate = formatDateLocal(info.date);

        // highlight ‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö
        if (examDays.includes(cellDate)) {
          info.el.style.backgroundColor = '#ffcccc'; // ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô
        }

        // highlight ‡∏ß‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á
        if (cellDate === simulatedToday) {
          info.el.style.border = '3px solid #ff9800'; // ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡πâ‡∏°
          info.el.style.backgroundColor = '#fff3cd';  // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡πà‡∏≠‡∏ô
        }
      }
    });

    calendar.render();
  });
</script>
{% endblock %}