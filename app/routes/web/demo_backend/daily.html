<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ตารางสล็อตอ่าน</title>
  <style>
    body { font-family: system-ui, sans-serif; }
    .container { max-width: 960px; margin: 24px auto; }
    .toolbar { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .day {
      border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; min-height: 120px;
      display: flex; flex-direction: column; gap: 6px; background: #fafafa;
    }
    .date { font-weight: 600; font-size: 12px; color: #374151; }
    .slot {
      display: flex; justify-content: space-between; font-size: 13px;
      background: white; border: 1px solid #eef2f7; border-radius: 6px; padding: 6px 8px;
    }
    .slot.review { border-color: #f59e0b; background: #fff7ed; } /* highlight review */
    .total { margin-top: auto; font-size: 12px; color: #6b7280; }
    .legend { display: flex; gap: 12px; font-size: 12px; color: #4b5563; margin: 8px 0 16px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; border:1px solid #e5e7eb; }
    .badge.review { border-color:#f59e0b; background:#fff7ed; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ตารางสล็อตอ่าน</h2>
    <div class="toolbar">
      <label>ผู้ใช้: <input id="userId" type="number" value="1" /></label>
      <label>เริ่ม: <input id="start" type="date" /></label>
      <label>สิ้นสุด: <input id="end" type="date" /></label>
      <button id="loadBtn">โหลด</button>
    </div>

    <div class="legend">
      <span class="badge">อ่านปกติ</span>
      <span class="badge review">วันทบทวน (ก่อนสอบ)</span>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <script>
    async function fetchAllocations(userId, start, end) {
      const params = new URLSearchParams({ user_id: userId });
      if (start) params.append('start', start);
      if (end) params.append('end', end);
      const res = await fetch(`/api/daily-allocations?${params.toString()}`);
      return res.json();
    }

    function renderGrid(data) {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      // Fill empty cells to align as weeks if you want (optional)
      for (const day of data) {
        const card = document.createElement('div');
        card.className = 'day';

        const dateEl = document.createElement('div');
        dateEl.className = 'date';
        dateEl.textContent = day.date;
        card.appendChild(dateEl);

        for (const s of day.slots) {
          const slot = document.createElement('div');
          slot.className = 'slot' + (s.is_review ? ' review' : '');
          slot.innerHTML = `
            <span>${s.exam_name}</span>
            <span>${s.hours} ชั่วโมง</span>
          `;
          card.appendChild(slot);
        }

        const total = document.createElement('div');
        total.className = 'total';
        total.textContent = `รวมวันนี้: ${day.daily_total} ชั่วโมง`;
        card.appendChild(total);

        grid.appendChild(card);
      }
    }

    document.getElementById('loadBtn').addEventListener('click', async () => {
      const userId = document.getElementById('userId').value;
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const data = await fetchAllocations(userId, start, end);
      renderGrid(data);
    });

    // auto-init: load current week
    (async () => {
      const today = new Date();
      const start = new Date(today); start.setDate(today.getDate() - today.getDay());
      const end = new Date(start); end.setDate(start.getDate() + 6);

      document.getElementById('start').value = start.toISOString().slice(0,10);
      document.getElementById('end').value = end.toISOString().slice(0,10);

      const data = await fetchAllocations(1, document.getElementById('start').value, document.getElementById('end').value);
      renderGrid(data);
    })();
  </script>
</body>
</html>
