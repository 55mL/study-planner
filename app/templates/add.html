<!-- 
 - File     : add.html
 - Descript : หน้าสำหรับเพิ่มวิชา ไอคอนตรงกลาง นับ 3 จากซ้าย ประกอบไปด้วย
 -            1. Label กรอกชื่อวิชา
 -            2. Label เลือกวันสอบ
 -            3. Difficulty slider เลือกระดับความยากง่ายของวิชา
 -            4. Add Subject button ปุ่มเพิ่มวิชา
 - Update   : 2025-10-12 (Added API Integration & Notification)
-->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Exam - Study Planner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>
<body data-page="add" class="page-add">
    
    <!-- Notification Toast -->
    <div id="notification" class="notification">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span id="notificationText">เพิ่มวิชาสอบสำเร็จ</span>
    </div>

    <div class="app-container">
        
        <main class="main-content">
            
            <header class="page-header">
                <div class="top-header">
                    <h1 class="page-title">เพิ่มวิชา</h1>
                    <!-- <p class="welcome-text">ห้ะ</p> -->
                </div>
            </header>

            <form id="addExamForm" class="add-exam-form">
                
                <!-- กรอกชื่อวิชา -->
                <div class="form-group">
                    <label for="subjectName" class="form-label">ชื่อวิชา</label>
                    <input 
                        type="text" 
                        id="subjectName" 
                        name="subjectName" 
                        class="form-input" 
                        placeholder="เช่น Calculus III"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="examDate" class="form-label">วันสอบ</label>
                    <input 
                        type="text" 
                        id="examDate" 
                        name="examDate" 
                        class="form-input" 
                        placeholder="คลิกเพื่อเลือกวันที่"
                        required
                    >
                </div>

                <!-- เลือกระดับความยากง่ายของวิชา -->
                <div class="form-group">
                    <label for="difficulty" class="form-label">ระดับความถนัด</label>
                    <div class="difficulty-slider">
                        <input 
                            type="range" 
                            id="difficulty" 
                            name="difficulty" 
                            class="slider-input" 
                            min="1" 
                            max="10" 
                            value="5"
                        >
                        <div class="slider-labels">
                            <span class="slider-label-easy">ง่าย (1-4)</span>
                            <span class="slider-label-medium">ปานกลาง (5-7)</span>
                            <span class="slider-label-hard">ยาก (8-10)</span>
                        </div>
                        <div class="difficulty-value" id="difficultyValue">5</div>
                    </div>
                    
                    <!-- หมายเหตุ -->
                    <p class="form-note">
                        <ion-icon name="information-circle-outline"></ion-icon>
                        หมายเหตุ: หากต้องการตั้งเวลาในการอ่านแต่ละวัน ไปที่การตั้งค่า > ตั้งค่าเวลาในการอ่านแต่ละวัน
                    </p>
                </div>

                <!-- ปุ่มเพิ่มวิชา -->
                <button type="submit" class="btn-primary">
                    <ion-icon name="checkmark-circle" style="vertical-align: middle; margin-right: 8px;"></ion-icon>
                    เพิ่ม
                </button>

            </form>

        </main>

        <!--nav bar-->
       <nav class="bottom-nav">
            <a href="{{ url_for('web_main.home') }}" class="nav-item" data-page="schedule">
                <ion-icon name="home"></ion-icon>
                <span>หน้าหลัก</span>
            </a>
            <a href="{{ url_for('web_main.feedback') }}" class="nav-item" data-page="home">
                <ion-icon name="checkmark-circle"></ion-icon>
                <span>บันทึก</span>
            </a>
            <a href="{{ url_for('web_main.add') }}" class="nav-item nav-item-center" data-page="add">
                <div class="add-button">
                    <ion-icon name="add"></ion-icon>
                </div>
            </a>
            <a href="{{ url_for('web_main.stat') }}" class="nav-item" data-page="stat">
                <ion-icon name="book"></ion-icon>
                <span>คู่มือ</span>
            </a>
            <a href="{{ url_for('web_main.profile') }}" class="nav-item" data-page="profile">
                <ion-icon name="person"></ion-icon>
                <span>ตั้งค่า</span>
            </a>
        </nav>
    </div>

    <style>
    .notification {
        position: fixed;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 9999;
        transition: top 0.3s ease-in-out;
        font-weight: 500;
    }

    .notification.show {
        top: 20px;
    }

    .notification ion-icon {
        font-size: 24px;
    }
    </style>

    <script>
        function setDayTheme() {
            const today = new Date();
            const dayIndex = today.getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            document.body.setAttribute('data-day', dayNames[dayIndex]);
        }
        setDayTheme();

        const currentPage = document.body.dataset.page;
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.dataset.page === currentPage) {
                item.classList.add('active');
            }
        });

        const difficultySlider = document.getElementById('difficulty');
        const difficultyValue = document.getElementById('difficultyValue');
        
        difficultySlider.addEventListener('input', function() {
            difficultyValue.textContent = this.value;
        });

        // จัดการ input วันที่
        const examDateInput = document.getElementById('examDate');
        
        examDateInput.addEventListener('focus', function() {
            this.type = 'date';
            // ใช้ click() แทน showPicker() เพื่อความเข้ากันได้
            setTimeout(() => {
                this.click();
            }, 100);
        });
        
        examDateInput.addEventListener('blur', function() {
            if (!this.value) {
                this.type = 'text';
            }
        });
        
        // ตั้งค่าเริ่มต้น
        examDateInput.type = 'text';

        // ฟังก์ชันแสดง notification
        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            if (!isSuccess) {
                notification.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // จัดการ form submission
        document.getElementById('addExamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const subjectName = document.getElementById('subjectName').value;
            const examDate = document.getElementById('examDate').value;
            const difficulty = document.getElementById('difficulty').value;
            
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<ion-icon name="hourglass-outline" style="vertical-align: middle; margin-right: 8px;"></ion-icon>กำลังเพิ่ม...';
            
            try {
                const response = await fetch('/api/plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        exam_name: subjectName,
                        exam_date: examDate,
                        level: parseInt(difficulty)
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('เพิ่มวิชาสอบสำเร็จ!', true);
                    
                    // รีเซ็ต form
                    this.reset();
                    difficultyValue.textContent = '5';
                    examDateInput.type = 'text'; // รีเซ็ต type เป็น text อีกครั้ง
                    
                    // redirect ไปหน้า home หลังจาก 1.5 วินาที
                    setTimeout(() => {
                        window.location.href = '/home';
                    }, 1500);
                } else {
                    showNotification(data.error || 'เกิดข้อผิดพลาดในการเพิ่มวิชา', false);
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อ', false);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<ion-icon name="checkmark-circle" style="vertical-align: middle; margin-right: 8px;"></ion-icon>เพิ่ม';
            }
        });
    </script>
</body>
</html>
