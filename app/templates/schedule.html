<!-- Update: 2025-10-10 5.00 PM(Neptune) - Fixed CSS & Dynamic Events -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - Study Planner</title>
    <link rel="stylesheet" href="/app/static/css/main.css">
    <link rel="stylesheet" href="/app/static/css/components.css">
    <link rel="stylesheet" href="/app/static/css/responsive.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
      /* ‚ö†Ô∏è ‡∏•‡∏ö CSS ‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö components.css ‡∏≠‡∏≠‡∏Å - ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å components.css ‡πÅ‡∏ó‡∏ô */
      /* ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ */
      .event-dot { 
        width:8px; 
        height:8px; 
        border-radius:50%; 
        background:#ff6b6b; 
        position:absolute; 
        right:8px; 
        bottom:8px; 
        display:inline-block; 
      }
      .day-heading { 
        font-weight:600; 
        margin-bottom:8px; 
      }
      .muted { 
        color: #666; 
        font-size:0.95rem; 
      }
    </style>
</head>
<body data-page="schedule">
    
    <div class="app-container">
        
        <main class="main-content">
            
            <header class="page-header">
                <div class="top-header">
                    <a href="home.html" class="back-item" data-page="home">
                    <ion-icon name="caret-back-circle"></ion-icon>
                    </a>
                    <h1 class="page-title">‡∏õ‡∏é‡∏¥‡∏ó‡∏¥‡∏ô</h1>
                </div>
            </header>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prevMonth" title="Previous month">
                        <ion-icon name="chevron-back"></ion-icon>
                    </button>
                    <h2 class="calendar-month" id="currentMonth">‚Äî</h2>
                    <button class="calendar-nav-btn" id="nextMonth" title="Next month">
                        <ion-icon name="chevron-forward"></ion-icon>
                    </button>
                </div>

                <div class="calendar-weekdays">
                    <div class="calendar-weekday">Sun</div>
                    <div class="calendar-weekday">Mon</div>
                    <div class="calendar-weekday">Tue</div>
                    <div class="calendar-weekday">Wed</div>
                    <div class="calendar-weekday">Thu</div>
                    <div class="calendar-weekday">Fri</div>
                    <div class="calendar-weekday">Sat</div>
                </div>

                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
                <div class="calendar-days" id="calendarDays"></div>
            </div>

            <section class="events-list">
                <h2 class="section-title">‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ</h2>
                
                <!-- Events ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API -->
                <div id="eventsContainer">
                    <!-- Loading state -->
                    <p class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </section>

        </main>

        <nav class="bottom-nav">
            <a href="schedule.html" class="nav-item" data-page="schedule">
                <ion-icon name="home"></ion-icon>
                <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
            <a href="home.html" class="nav-item" data-page="home">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </a>
            <a href="add.html" class="nav-item nav-item-center" data-page="add">
                <div class="add-button">
                    <ion-icon name="add"></ion-icon>
                </div>
            </a>
            <a href="stat.html" class="nav-item" data-page="stat">
                <ion-icon name="stats-chart"></ion-icon>
                <span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
            </a>
            <a href="profile.html" class="nav-item" data-page="profile">
                <ion-icon name="person"></ion-icon>
                <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </a>
        </nav>

    </div>

    <script>
        // ====== config ======
        const WEEK_START = 0; // 0 = Sunday

        // ====== state ======
        const todayReal = new Date();
        let viewYear = todayReal.getFullYear();
        let viewMonth = todayReal.getMonth();
        let eventsData = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• events ‡∏à‡∏≤‡∏Å API

        // ====== Load events from API ======
        async function loadEventsFromAPI() {
            try {
                const response = await fetch('/api/schedule');
                if (!response.ok) {
                    throw new Error('Failed to fetch schedule');
                }
                const data = await response.json();
                
                // ‡πÅ‡∏õ‡∏•‡∏á events array ‡πÄ‡∏õ‡πá‡∏ô map: date -> event data
                eventsData = {};
                data.events.forEach(event => {
                    const dateKey = event.day; // ISO format: YYYY-MM-DD
                    if (!eventsData[dateKey]) {
                        eventsData[dateKey] = [];
                    }
                    eventsData[dateKey].push(event);
                });

                // Render calendar ‡πÅ‡∏•‡∏∞ events list
                renderCalendar(viewYear, viewMonth);
                renderEventsList();
                
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsContainer').innerHTML = 
                    '<p class="muted">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>';
            }
        }

        // ====== Render events list ======
        function renderEventsList(filterDate = null) {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = '';

            // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
            const heading = document.createElement('div');
            heading.className = 'day-heading muted';
            heading.textContent = filterDate 
                ? `‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${filterDate}` 
                : '‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            container.appendChild(heading);

            // ‡∏Å‡∏£‡∏≠‡∏á events
            let displayEvents = [];
            if (filterDate) {
                displayEvents = eventsData[filterDate] || [];
            } else {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                Object.keys(eventsData).sort().forEach(date => {
                    displayEvents.push(...eventsData[date]);
                });
            }

            if (displayEvents.length === 0) {
                container.innerHTML += '<p class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>';
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á event cards
            displayEvents.forEach(event => {
                const card = document.createElement('div');
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î difficulty class
                let difficultyClass = 'difficulty-medium';
                const slots = event.slots || 0;
                if (slots <= 3) difficultyClass = 'difficulty-easy';
                else if (slots >= 7) difficultyClass = 'difficulty-hard';
                
                card.className = `event-card ${difficultyClass}`;
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
                const dateObj = new Date(event.day);
                const dateStr = dateObj.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                card.innerHTML = `
                    <h3 class="event-title">${event.exam || 'Unknown'}</h3>
                    <div class="event-meta">
                        <span>
                            <ion-icon name="calendar-outline"></ion-icon>
                            ${dateStr}
                        </span>
                        <span>
                            <ion-icon name="time-outline"></ion-icon>
                            ${event.slots || 0} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                        </span>
                        ${event.is_exam_day ? '<span style="color: #E74C3C; font-weight: 600;">üìù ‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö</span>' : ''}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // ====== helper ======
        function monthLabelThai(year, monthIndex) {
            const d = new Date(year, monthIndex, 1);
            return d.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
        }

        // ====== Render Calendar ======
        function renderCalendar(year, month) {
            const currentMonthEl = document.getElementById('currentMonth');
            currentMonthEl.textContent = monthLabelThai(year, month);

            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            const firstOfMonth = new Date(year, month, 1);
            let firstWeekday = firstOfMonth.getDay();
            firstWeekday = (firstWeekday - WEEK_START + 7) % 7;

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();

            for (let i = 0; i < 42; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                const idx = i - firstWeekday + 1;
                let cellDate = null;
                let isOtherMonth = false;
                let dayNumber = 1;

                if (idx <= 0) {
                    isOtherMonth = true;
                    dayNumber = prevMonthDays + idx;
                    cellDate = new Date(year, month - 1, dayNumber);
                    cell.classList.add('other-month');
                } else if (idx > daysInMonth) {
                    isOtherMonth = true;
                    dayNumber = idx - daysInMonth;
                    cellDate = new Date(year, month + 1, dayNumber);
                    cell.classList.add('other-month');
                } else {
                    dayNumber = idx;
                    cellDate = new Date(year, month, dayNumber);

                    const todayIso = new Date().toISOString().slice(0,10);
                    if (cellDate.toISOString().slice(0,10) === todayIso) {
                        cell.classList.add('today');
                    }
                }

                const span = document.createElement('div');
                span.className = 'date-number';
                span.textContent = dayNumber;
                cell.appendChild(span);

                const iso = cellDate.toISOString().slice(0,10);
                cell.dataset.iso = iso;

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ event ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°
                if (eventsData[iso] && eventsData[iso].length > 0) {
                    cell.classList.add('has-event');
                    const dot = document.createElement('span');
                    dot.className = 'event-dot';
                    dot.title = eventsData[iso].map(e => e.exam || 'Event').join(', ');
                    cell.appendChild(dot);
                }

                cell.addEventListener('click', () => {
                    renderEventsList(iso);
                });

                container.appendChild(cell);
            }
        }

        // ====== Navigation ======
        document.getElementById('prevMonth').addEventListener('click', () => {
            viewMonth--;
            if (viewMonth < 0) { viewMonth = 11; viewYear--; }
            renderCalendar(viewYear, viewMonth);
            renderEventsList(null);
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            viewMonth++;
            if (viewMonth > 11) { viewMonth = 0; viewYear++; }
            renderCalendar(viewYear, viewMonth);
            renderEventsList(null);
        });

        // ====== Theme & Active Nav ======
        function setDayTheme() {
            const today = new Date();
            const dayIndex = today.getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            document.body.setAttribute('data-day', dayNames[dayIndex]);
        }
        setDayTheme();

        const currentPage = document.body.dataset.page;
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.dataset.page === currentPage) {
                item.classList.add('active');
            }
        });

        // ====== Initialize ======
        loadEventsFromAPI();

       
    </script>
</body>
</html>