<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - Study Planner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
      .event-dot { 
        width:8px; 
        height:8px; 
        border-radius:50%; 
        background:#ff6b6b; 
        position:absolute; 
        right:8px; 
        bottom:8px; 
        display:inline-block; 
      }
      .day-heading { 
        font-weight:600; 
        margin-bottom:8px; 
      }
      .muted { 
        color: #666; 
        font-size:0.95rem; 
      }
    </style>
</head>
<body data-page="schedule">
    
    <div class="app-container">
        
        <main class="main-content">
            
            <header class="page-header">
                <div class="top-header">
                    <a href="{{ url_for('web_main.feedback') }}" class="back-item" data-page="home">
                        <ion-icon name="caret-back-circle"></ion-icon>
                    </a>
                    <h1 class="page-title">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h1>
                </div>
            </header>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prevMonth" title="Previous month">
                        <ion-icon name="chevron-back"></ion-icon>
                    </button>
                    <h2 class="calendar-month" id="currentMonth">‚Äî</h2>
                    <button class="calendar-nav-btn" id="nextMonth" title="Next month">
                        <ion-icon name="chevron-forward"></ion-icon>
                    </button>
                </div>

                <div class="calendar-weekdays">
                    <div class="calendar-weekday">Sun</div>
                    <div class="calendar-weekday">Mon</div>
                    <div class="calendar-weekday">Tue</div>
                    <div class="calendar-weekday">Wed</div>
                    <div class="calendar-weekday">Thu</div>
                    <div class="calendar-weekday">Fri</div>
                    <div class="calendar-weekday">Sat</div>
                </div>

                <div class="calendar-days" id="calendarDays"></div>
            </div>

            <section class="events-list">
                <h2 class="section-title">‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ</h2>
                
                <div id="eventsContainer">
                    <p class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </section>

        </main>

        <nav class="bottom-nav">
            <a href="{{ url_for('web_main.home') }}" class="nav-item active" data-page="schedule">
                <ion-icon name="home"></ion-icon>
                <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
            <a href="{{ url_for('web_main.feedback') }}" class="nav-item" data-page="home">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </a>
            <a href="{{ url_for('web_main.add') }}" class="nav-item nav-item-center" data-page="add">
                <div class="add-button">
                    <ion-icon name="add"></ion-icon>
                </div>
            </a>
            <a href="{{ url_for('web_main.stat') }}" class="nav-item" data-page="stat">
                <ion-icon name="stats-chart"></ion-icon>
                <span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
            </a>
            <a href="{{ url_for('web_main.profile') }}" class="nav-item" data-page="profile">
                <ion-icon name="person"></ion-icon>
                <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </a>
        </nav>

    </div>

    <script>
    // ====== config ======
    const WEEK_START = 0;

    // ====== state ======
    const todayReal = new Date();
    let viewYear = todayReal.getFullYear();
    let viewMonth = todayReal.getMonth();
    let eventsData = {};
    let isDataLoaded = false;

    // ====== helper ======
    function monthLabelThai(year, monthIndex) {
        const d = new Date(year, monthIndex, 1);
        return d.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
    }

    // ====== Load events from API ======
    async function loadEventsFromAPI() {
        const container = document.getElementById('eventsContainer');
        
        console.log('üöÄ Starting to load events...');
        
        try {
            container.innerHTML = '<p class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
            
            console.log('üì° Fetching /api/schedule...');
            const response = await fetch('/api/schedule');
            
            console.log('üì• Response status:', response.status);
            console.log('üì• Response ok:', response.ok);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Server error:', errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            console.log('üì¶ Raw data received:', data);
            console.log('üì¶ Events count:', data.events ? data.events.length : 0);
            
            // ‡πÅ‡∏õ‡∏•‡∏á events array ‡πÄ‡∏õ‡πá‡∏ô map
            eventsData = {};
            if (data.events && Array.isArray(data.events)) {
                data.events.forEach(event => {
                    const dateKey = event.day;
                    if (!eventsData[dateKey]) {
                        eventsData[dateKey] = [];
                    }
                    eventsData[dateKey].push(event);
                });
            }

            console.log('üóìÔ∏è Processed eventsData:', eventsData);
            console.log('üóìÔ∏è Total dates with events:', Object.keys(eventsData).length);
            
            isDataLoaded = true;
            console.log('‚úÖ isDataLoaded set to true');
            
            renderCalendar(viewYear, viewMonth);
            renderEventsList();
            
            console.log('‚úÖ Rendering complete');
            
        } catch (error) {
            console.error('‚ùå Error loading events:', error);
            console.error('‚ùå Error message:', error.message);
            console.error('‚ùå Error stack:', error.stack);
            container.innerHTML = 
                `<p class="muted" style="color: #e74c3c;">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}</p>`;
        }
    }

    // ====== Render events list ======
    function renderEventsList(filterDate = null) {
        console.log('üìù renderEventsList called, filterDate:', filterDate);
        console.log('üìù isDataLoaded:', isDataLoaded);
        
        const container = document.getElementById('eventsContainer');
        
        if (!isDataLoaded) {
            console.log('‚è≥ Data not loaded yet');
            container.innerHTML = '<p class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
            return;
        }
        
        container.innerHTML = '';

        const heading = document.createElement('div');
        heading.className = 'day-heading muted';
        heading.textContent = filterDate 
            ? `‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${new Date(filterDate).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}` 
            : '‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        container.appendChild(heading);

        let displayEvents = [];
        if (filterDate) {
            displayEvents = eventsData[filterDate] || [];
        } else {
            Object.keys(eventsData).sort().forEach(date => {
                displayEvents.push(...eventsData[date]);
            });
        }

        console.log('üìù Display events count:', displayEvents.length);

        if (displayEvents.length === 0) {
            container.innerHTML += '<p class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>';
            return;
        }

        displayEvents.forEach(event => {
            const card = document.createElement('div');
            
            let difficultyClass = 'difficulty-medium';
            const slots = event.slots || 0;
            if (slots <= 3) difficultyClass = 'difficulty-easy';
            else if (slots >= 7) difficultyClass = 'difficulty-hard';
            
            card.className = `event-card ${difficultyClass}`;
            
            const dateObj = new Date(event.day);
            const dateStr = dateObj.toLocaleDateString('th-TH', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            card.innerHTML = `
                <h3 class="event-title">${event.exam || 'Unknown'}</h3>
                <div class="event-meta">
                    <span>
                        <ion-icon name="calendar-outline"></ion-icon>
                        ${dateStr}
                    </span>
                    <span>
                        <ion-icon name="time-outline"></ion-icon>
                        ${event.slots || 0} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                    </span>
                    ${event.is_exam_day ? '<span style="color: #E74C3C; font-weight: 600;">üìù ‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö</span>' : ''}
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    // ====== Render Calendar ======
    function renderCalendar(year, month) {
        console.log('üìÖ renderCalendar called:', year, month);
        console.log('üìÖ isDataLoaded:', isDataLoaded);
        
        if (!isDataLoaded) {
            console.log('‚è≥ Data not loaded, skipping calendar render');
            return;
        }
        
        const currentMonthEl = document.getElementById('currentMonth');
        currentMonthEl.textContent = monthLabelThai(year, month);

        const container = document.getElementById('calendarDays');
        container.innerHTML = '';

        const firstOfMonth = new Date(year, month, 1);
        let firstWeekday = firstOfMonth.getDay();
        firstWeekday = (firstWeekday - WEEK_START + 7) % 7;

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const prevMonthDays = new Date(year, month, 0).getDate();

        for (let i = 0; i < 42; i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            const idx = i - firstWeekday + 1;
            let cellDate = null;
            let dayNumber = 1;

            if (idx <= 0) {
                dayNumber = prevMonthDays + idx;
                cellDate = new Date(year, month - 1, dayNumber);
                cell.classList.add('other-month');
            } else if (idx > daysInMonth) {
                dayNumber = idx - daysInMonth;
                cellDate = new Date(year, month + 1, dayNumber);
                cell.classList.add('other-month');
            } else {
                dayNumber = idx;
                cellDate = new Date(year, month, dayNumber);

                const todayIso = new Date().toISOString().slice(0,10);
                if (cellDate.toISOString().slice(0,10) === todayIso) {
                    cell.classList.add('today');
                }
            }

            const span = document.createElement('div');
            span.className = 'date-number';
            span.textContent = dayNumber;
            cell.appendChild(span);

            const iso = cellDate.toISOString().slice(0,10);
            cell.dataset.iso = iso;

            if (eventsData[iso] && eventsData[iso].length > 0) {
                cell.classList.add('has-event');
                const dot = document.createElement('span');
                dot.className = 'event-dot';
                dot.title = eventsData[iso].map(e => e.exam || 'Event').join(', ');
                cell.appendChild(dot);
            }

            cell.addEventListener('click', () => {
                renderEventsList(iso);
            });

            container.appendChild(cell);
        }
        
        console.log('üìÖ Calendar rendered successfully');
    }

    // ====== Initialize ======
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üé¨ DOM Content Loaded');
        
        // Theme & Active Nav
        function setDayTheme() {
            const today = new Date();
            const dayIndex = today.getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            document.body.setAttribute('data-day', dayNames[dayIndex]);
        }
        setDayTheme();

        const currentPage = document.body.dataset.page;
        document.querySelectorAll('.nav-item').forEach(item => {
            if (item.dataset.page === currentPage) {
                item.classList.add('active');
            }
        });

        // ‚úÖ Navigation - ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô DOMContentLoaded
        const prevBtn = document.getElementById('prevMonth');
        const nextBtn = document.getElementById('nextMonth');
        
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                console.log('‚¨ÖÔ∏è Previous month clicked');
                viewMonth--;
                if (viewMonth < 0) { viewMonth = 11; viewYear--; }
                renderCalendar(viewYear, viewMonth);
                renderEventsList(null);
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                console.log('‚û°Ô∏è Next month clicked');
                viewMonth++;
                if (viewMonth > 11) { viewMonth = 0; viewYear++; }
                renderCalendar(viewYear, viewMonth);
                renderEventsList(null);
            });
        }

        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
        loadEventsFromAPI();
    });
    </script>
</body>
</html>