<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - Study Planner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>
<body data-page="schedule">

    <div class="app-container">
        <main class="main-content">
            <header class="page-header">
                <div class="top-header">
                    <a href="{{ url_for('web_main.feedback') }}" class="back-item" data-page="home">
                        <ion-icon name="caret-back-circle"></ion-icon>
                    </a>
                    <h1 class="page-title">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h1>
                </div>
            </header>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prevMonth" title="Previous month">
                        <ion-icon name="chevron-back"></ion-icon>
                    </button>
                    <h2 class="calendar-month" id="currentMonth">‚Äî</h2>
                    <button class="calendar-nav-btn" id="nextMonth" title="Next month">
                        <ion-icon name="chevron-forward"></ion-icon>
                    </button>
                </div>

                <div class="calendar-weekdays">
                    <div class="calendar-weekday">Sun</div>
                    <div class="calendar-weekday">Mon</div>
                    <div class="calendar-weekday">Tue</div>
                    <div class="calendar-weekday">Wed</div>
                    <div class="calendar-weekday">Thu</div>
                    <div class="calendar-weekday">Fri</div>
                    <div class="calendar-weekday">Sat</div>
                </div>

                <div class="calendar-days" id="calendarDays"></div>
            </div>

            <section class="events-list">
                <h2 class="section-title">‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ</h2>
                <div id="eventsContainer">
                    <p class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="{{ url_for('web_main.home') }}" class="nav-item active" data-page="schedule">
                <ion-icon name="home"></ion-icon>
                <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
            <a href="{{ url_for('web_main.feedback') }}" class="nav-item" data-page="home">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
            </a>
            <a href="{{ url_for('web_main.add') }}" class="nav-item nav-item-center" data-page="add">
                <div class="add-button">
                    <ion-icon name="add"></ion-icon>
                </div>
            </a>
            <a href="{{ url_for('web_main.stat') }}" class="nav-item" data-page="stat">
                <ion-icon name="stats-chart"></ion-icon>
                <span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span>
            </a>
            <a href="{{ url_for('web_main.profile') }}" class="nav-item" data-page="profile">
                <ion-icon name="person"></ion-icon>
                <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </a>
        </nav>
    </div>
    <script>
    // ===== config =====
    const WEEK_START = 0;

    // ===== state =====
    const todayReal = new Date();
    let viewYear = todayReal.getFullYear();
    let viewMonth = todayReal.getMonth();
    let eventsData = {};
    let isDataLoaded = false;
    let selectedDate = null; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° state ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

    // ===== helpers =====
    function toLocalISO(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }
    function parseLocalDate(isoString) {
        const [y, m, d] = isoString.split('-').map(Number);
        return new Date(y, m - 1, d, 12, 0, 0);
    }
    function formatThaiDate(isoString, options = {}) {
        const dt = parseLocalDate(isoString);
        return dt.toLocaleDateString('th-TH', options);
    }

    // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏à‡∏≤‡∏Å CSS variables ‡πÅ‡∏ó‡∏ô hardcode
    const todayWeekday = todayReal.getDay();
    const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
    
    // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏µ‡∏à‡∏≤‡∏Å CSS variables ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô
    const rootStyles = getComputedStyle(document.documentElement);
    const dayColorMap = {
      0: '--sunday-secondary',
      1: '--monday-secondary',
      2: '--tuesday-secondary',
      3: '--wednesday-secondary',
      4: '--thursday-secondary',
      5: '--friday-secondary',
      6: '--saturday-secondary'
    };
    
    function getCurrentDayColor() {
        const varName = dayColorMap[todayWeekday];
        return getComputedStyle(document.body).getPropertyValue(varName).trim() || '#66BB6A';
    }

    console.log('‚úÖ Today weekday:', todayWeekday);

    // ===== load events =====
    async function loadEventsFromAPI() {
        const container = document.getElementById('eventsContainer');
        try {
            container.innerHTML = '<p class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
            const res = await fetch('/api/schedule');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            eventsData = {};
            if (data.events && Array.isArray(data.events)) {
                data.events.forEach(ev => {
                    const day = ev.day;
                    if (!eventsData[day]) eventsData[day] = [];
                    eventsData[day].push(ev);
                });
            }
            isDataLoaded = true;
            renderCalendar(viewYear, viewMonth);
            renderEventsList();
        } catch (err) {
            console.error('Error loading events', err);
            container.innerHTML = `<p class="muted" style="color:var(--difficulty-hard)">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${err.message}</p>`;
        }
    }

    // ===== render events list =====
    function renderEventsList(filterDate = null) {
        const container = document.getElementById('eventsContainer');
        if (!isDataLoaded) {
            container.innerHTML = '<p class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';
            return;
        }
        container.innerHTML = '';
        const heading = document.createElement('div');
        heading.className = 'day-heading muted';
        if (filterDate) {
            heading.textContent = `‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${formatThaiDate(filterDate, { year:'numeric', month:'long', day:'numeric' })}`;
        } else {
            heading.textContent = '‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        }
        container.appendChild(heading);

        let displayEvents = [];
        if (filterDate) {
            displayEvents = eventsData[filterDate] || [];
        } else {
            Object.keys(eventsData).sort().forEach(d => displayEvents.push(...eventsData[d]));
        }

        if (displayEvents.length === 0) {
            container.innerHTML += '<p class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>';
            return;
        }

        displayEvents.forEach(ev => {
            const card = document.createElement('div');
            card.className = 'event-card';
            
            // ‚úÖ ‡πÉ‡∏ä‡πâ class difficulty ‡πÅ‡∏ó‡∏ô inline style
            if (typeof ev.level === 'number') {
                const level = Math.max(1, Math.min(10, ev.level));
                card.classList.add(`difficulty-${level}`);
            }

            const dateStr = formatThaiDate(ev.day, { month:'short', day:'numeric', year:'numeric' });
            const levelText = (typeof ev.level === 'number') ? `‡∏£‡∏∞‡∏î‡∏±‡∏ö ${ev.level}` : '';
            const slotsText = `${ev.slots || 0} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;

            const hoursDisplay = ev.is_exam_day 
                ? '' 
                : `<span class="meta-hours"><ion-icon name="time-outline"></ion-icon> ${slotsText}</span>`;

            card.innerHTML = `
                <h3 class="event-title">${ev.exam || 'Unknown'}</h3>
                <div class="event-meta">
                    <span class="meta-date"><ion-icon name="calendar-outline"></ion-icon> ${dateStr}</span>
                    ${levelText ? `<span class="meta-level"><span class="level-badge">üî• ${levelText}</span></span>` : ''}
                    ${hoursDisplay}
                    ${ev.is_exam_day ? '<span style="color:var(--difficulty-hard); font-weight:600;">üìù ‡∏ß‡∏±‡∏ô‡∏™‡∏≠‡∏ö</span>' : ''}
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    // ===== render calendar =====
    function renderCalendar(year, month) {
        if (!isDataLoaded) return;
        const currentMonthEl = document.getElementById('currentMonth');
        const d = new Date(year, month, 1);
        currentMonthEl.textContent = d.toLocaleString('th-TH', { month:'long', year:'numeric' });

        const container = document.getElementById('calendarDays');
        container.innerHTML = '';

        const firstOfMonth = new Date(year, month, 1);
        let firstWeekday = firstOfMonth.getDay();
        firstWeekday = (firstWeekday - WEEK_START + 7) % 7;
        const daysInMonth = new Date(year, month+1, 0).getDate();
        const prevMonthDays = new Date(year, month, 0).getDate();
        
        const currentDayColor = getCurrentDayColor();

        for (let i=0;i<42;i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            const idx = i - firstWeekday + 1;
            let cellDate;
            let dayNumber;

            if (idx <= 0) {
                dayNumber = prevMonthDays + idx;
                cellDate = new Date(year, month - 1, dayNumber, 12);
                cell.classList.add('other-month');
            } else if (idx > daysInMonth) {
                dayNumber = idx - daysInMonth;
                cellDate = new Date(year, month + 1, dayNumber, 12);
                cell.classList.add('other-month');
            } else {
                dayNumber = idx;
                cellDate = new Date(year, month, dayNumber, 12);
                const todayIso = toLocalISO(new Date());
                if (toLocalISO(cellDate) === todayIso) {
                    cell.classList.add('today');
                }
            }

            const span = document.createElement('div');
            span.className = 'date-number';
            span.textContent = dayNumber;
            cell.appendChild(span);

            const iso = toLocalISO(cellDate);
            cell.dataset.iso = iso;

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° class selected ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (selectedDate === iso) {
                cell.classList.add('selected');
            }

            const dayEvents = eventsData[iso] || [];
            const hasStudy = dayEvents.some(e => e.event_type === 'study');
            const hasExam = dayEvents.some(e => e.event_type === 'exam');

            if (hasStudy && !hasExam) {
                const studyDot = document.createElement('span');
                studyDot.className = 'event-dot normal dot-center study';
                studyDot.style.background = currentDayColor;
                cell.appendChild(studyDot);
                cell.classList.add('has-event');
            } else if (!hasStudy && hasExam) {
                const examDot = document.createElement('span');
                examDot.className = 'event-dot normal dot-center exam';
                cell.appendChild(examDot);
                cell.classList.add('has-event');
            } else if (hasStudy && hasExam) {
                const studyDot = document.createElement('span');
                studyDot.className = 'event-dot small dot-center study';
                studyDot.style.background = currentDayColor;
                cell.appendChild(studyDot);

                const examDot = document.createElement('span');
                examDot.className = 'event-dot normal dot-exam-offset exam';
                cell.appendChild(examDot);

                cell.classList.add('has-event');
            }

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° logic ‡πÄ‡∏Å‡πá‡∏ö selectedDate ‡πÅ‡∏•‡∏∞ render ‡πÉ‡∏´‡∏°‡πà
            cell.addEventListener('click', () => {
                selectedDate = iso;
                renderCalendar(viewYear, viewMonth);
                renderEventsList(iso);
            });

            container.appendChild(cell);
        }
    }

    // ===== init =====
    document.addEventListener('DOMContentLoaded', function() {
        function setDayTheme() {
            const today = new Date();
            const dayIndex = today.getDay();
            const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
            document.body.setAttribute('data-day', dayNames[dayIndex]);
        }
        setDayTheme();

        document.getElementById('prevMonth').addEventListener('click', () => {
            viewMonth--;
            if (viewMonth < 0) { viewMonth = 11; viewYear--; }
            selectedDate = null; // ‚úÖ reset selection ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            renderCalendar(viewYear, viewMonth);
            renderEventsList(null);
        });
        
        document.getElementById('nextMonth').addEventListener('click', () => {
            viewMonth++;
            if (viewMonth > 11) { viewMonth = 0; viewYear++; }
            selectedDate = null; // ‚úÖ reset selection ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            renderCalendar(viewYear, viewMonth);
            renderEventsList(null);
        });

        loadEventsFromAPI();
    });
    </script>
</body>
</html>